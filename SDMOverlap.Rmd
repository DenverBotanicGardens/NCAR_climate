---
title: "SDM Overlap"
author: "Michelle DePrenger-Levin"
date: "October 17, 2018"
output: html_document
---

```{r}
library(raster)


load("Q:/Research/Projects/alpine-phenology/Uncertainty in niche modeling/Data/g1g2names.Rda")
load("Q:/Research/Projects/alpine-phenology/Uncertainty in niche modeling/Data/distXsp1.Rda")

want <- which(!is.na(mapply('[[', distXsp, 1)))

```

Just testing
```{r}
testin <-  raster(paste("Q:/Research/Projects/alpine-phenology/Uncertainty in niche modeling/RMaxEnt/MeanRasterstackEOR",gsub(" ","_","Penstemon degeneri"),"1.tif", sep=""))
#The average is an average, no long bin, need to convert
testin[testin>0.5] <- 1
testin[testin<=0.5] <- 0

plot(testin)

```

```{r}
want[c(1,2,4,7,8,9,15,)]

#really only have 20 species 
sp20 <- g1g2names$AcceptedName[c(1,2,7,10,11,12,16,19,21,22,24,27,35,36,38,41,42,43,45,46)]

Herbrasters <- lapply(sp20, function(sp){
  eorin <- raster(paste("Q:/Research/Projects/alpine-phenology/Uncertainty in niche modeling/RMaxEnt/MeanRasterstackEOR",gsub(" ","_",sp),"1.tif", sep=""))
  herbin <- raster(paste("Q:/Research/Projects/alpine-phenology/Uncertainty in niche modeling/RMaxEnt/MeanRasterstackHerb",gsub(" ","_",sp),"1.tif", sep=""))
  
  #Where there is overlap between AsMiEormatchss and AsMi assign a 2 instead of 1 to AsMiEormatchss
  herbin[herbin>0.5] <- 1
  herbin[herbin<=0.5] <- 0
  
  #to see overlap (3) and differentiate from only EOR (2), only herb (1) 
  eorin[eorin>0.5] <- 2
  eorin[eorin<=0.5] <- 0
  
  out <- herbin+eorin
  #Overlap
  overlap <- out
  overlap[overlap!=3] <- NA
  overlapsum <- cellStats(overlap, stat='sum', na.rm=TRUE)
  eoronly <- out
  eoronly[eoronly!=2] <-NA
  eoronlysum <- cellStats(eoronly, stat='sum', na.rm=TRUE)
  herbonly <- out
  herbonly[herbonly!=1] <- NA
  herbonlysum <- cellStats(herbonly, stat='sum', na.rm=TRUE)
  
  outdf <- data.frame(Overlap=overlapsum, EORonly=eoronlysum, Herbonly=herbonlysum)
  outdf
})

overlapall <- do.call(rbind, Herbrasters)


```

```{r}

overlapall$totalarea <- rowSums(overlapall)
overlapall$Species <- sp20

#Want to add a distance average and SD and total area for each species
distXsp1 <- mapply('[[', distXsp, 1)
#go by speciesID??
distXsp1 <- do.call(rbind,distXsp1[!is.na(distXsp1)])
# distXsp1[!duplicated(distXsp1[,c("scientificName","SpeciesID")]),]
specnum <- as.data.frame(table(distXsp1$SpeciesID,distXsp1$scientificName))
specnum[specnum$Freq>0,]
distXsp1[distXsp1$scientificName %in% sp20,]@data


```


```{r}
areaoutcat2 <- outcat2
areaoutcat2[areaoutcat2!=3] <- NA
#tryagain<- projectRaster(outcat, crs = "+proj=utm +zone=13 +datum=NAD83 +units=m +no_defs +ellps=GRS80 +towgs84=0,0,0", method="ngb")
raster::area(areaoutcat2, na.rm=TRUE)

areaoutcat2raster <- rasterToPolygons(areaoutcat2)
out2proj <- spTransform(areaoutcat2raster, CRS(proj4string(colocounties.UTM)))
sum(gArea(out2proj, byid=TRUE))/(1000^2) #divided by 1km squared: 1043.532 square km

#Sum rasters that are overlap ==3 and multiply by cell size, but this is in decimal seconds at this latitude so about 1km is 1 and this is 0.00083 or whatevers
sum(outcat[] == 3)*res(outcat)[1]^2
sum(outcat2[] == 3)*res(outcat2)[1]^2

```

