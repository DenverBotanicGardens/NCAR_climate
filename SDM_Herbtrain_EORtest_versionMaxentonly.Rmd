---
title: "SDM_Herbtrain_EORtest"
author: "Michelle DePrenger-Levin"
date: "November 3, 2018"
output: html_document
---

```{r}
library(ENMeval)
library(maptools)
library(sp)
library(rgeos)
library(spdep)
library(rgdal)
library(maptools)
library(raster)
library(dismo)

load("Q:/Research/Projects/alpine-phenology/Uncertainty in niche modeling/Data/Maxentspecies.Rda")

load("Q:/Research/Projects/alpine-phenology/Uncertainty in niche modeling/Data/distXsp1.Rda")
colocounties <- readOGR(dsn="Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_GENERAL_non-species_files/All_General_Background_Layers/Colorado/CO_Counties", layer="counties_wgs84")

load("Q:/Research/Projects/alpine-phenology/Uncertainty in niche modeling/Data/pca_data4.Rda")

```



```{r}
coElev <- raster("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_GENERAL_non-species_files/All_General_Background_Layers/Colorado/Elevation_VT/CO_Mosaic_Elevation_VT/co_elev_VT_WGS84.tif")
coAspect <- raster("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_GENERAL_non-species_files/All_General_Background_Layers/Colorado/Aspect_VT/co_aspect_VT_WGS84.tif")
coSlope <- raster("Q:/Research/All_Projects_by_Species/aa_Shapefiles_Maps/aa_GENERAL_non-species_files/All_General_Background_Layers/Colorado/Slope_VT/co_slope_VT_WGS84.tif")

rasterstack_2 <- stack(list(coElev, coAspect, coSlope))
rscrs_2 <- rasterstack_2@crs@projargs # "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
```



```{r}
#Loop through all the species
Maxentspecies <- lapply(1:60, function(i){
  checkrecords <- pca_herb_SAE[[herbposition[i]]]
  checkeor <- backgroundEORs[[backeorposition[[i]]]]
  if(is.null(checkrecords)){
    NULL
  } else {
    if(is.null(checkeor)){
      NULL
    } else {
    
    # to keep at least 5 records per group
      x <- checkrecords
      x <- x[!grepl("-99",x$Lastobs),]
      x <- x[x$Lastobs!="",]
      x <- x[(as.Date(x$Lastobs)>"1980-12-31"),]
      
      y <- pca_eor_SAE[[pca_eorposition[i]]]
      y <- y[!grepl("-99",y$Lastobs),]
      y <- y[(as.Date(y$Lastobs)>"1980-12-31"),]
      
    if(nrow(x)<10){
      NULL
      } else {
            train_pHerb <- x[,c("decimalLongitude","decimalLatitude")]
            train_bHerb <- bg.herb_SAE[[herbposition[i]]][,c("x1","x2")]
            
            test_pEOR <- pca_eor_SAE[[pca_eorposition[i]]][,c("x1","x2")]
            test_bEOR <- backgroundEORs[[backeorposition[i]]][,c("x1","x2")]
            
            meHerb <- maxent(rasterstack_2, p=train_pHerb, a=train_bHerb, 
                             path = paste("Q:/Research/Projects/alpine-phenology/Uncertainty in niche modeling/RMaxEnt/",g1g2names$AcceptedName[i],sep=""))
            
            #evalidate teh model
            e <- dismo::evaluate(test_pEOR, test_bEOR, meHerb, rasterstack_2)
            gc()
            
            #Visulatize predictions
            writeRaster(dismo::predict(meHerb, rasterstack_2),paste("Q:/Research/Projects/alpine-phenology/Uncertainty in niche modeling/RMaxEnt/Herbtrain_eortest_post1980",g1g2names$AcceptedName[i],".tif", sep=""),overwrite=TRUE)
            gc()
            thres <- dismo::threshold(e) 

            out <- list(meHerb,e,thres,e@auc,e@kappa,g1g2names$AcceptedName[i],
                        nrow(checkrecords),nrow(x),
                        nrow(pca_eor_SAE[[pca_eorposition[i]]]), nrow(y))
            out

        }
    }}
  })

save(Maxentspecies, file= "Q:/Research/Projects/alpine-phenology/Uncertainty in niche modeling/Data/Maxentspecies.Rda")


```

```{r}
Maxentspecies[[1]]

outputs <- mapply( '[[',Maxentspecies, 2)
names <- mapply('[[', Maxentspecies, 6)
auc_max <- mapply('[[', Maxentspecies, 4)

length(names)
outputs[[1]]

# HERE ARE VALUES! AUC 
AUCtable <- data.frame(Sp=unlist(names),AUC=unlist(auc_max))


# Average distance by species DIST
namesdistXsp <- mapply('[[',distXsp, 1)

# namesdistXsp <- 
  unlist(lapply(, function(x) unique(namesdistXsp[[x]]@data$scientificName)))
DISTtable <- data.frame(Sp=)


maxentposition <- mapply(function(x,y) x %in% y,
                         lapply(1:60, function(i){
                           c(g1g2names$AcceptedName[i],g1g2names$Taxon[i])
                           }),
                         mapply(FUN=function(x) x[[6]],Maxentspecies))

MEpos <- apply(maxentposition,2, function(x) sum(x) )


# 
# which(MEpos>0)
# length(which(MEpos>0)) #28

MEposition <- match(1:60,which(MEpos>0))
mepo <- which(!is.na(MEposition))

length(maxentposition[!is.na(maxentposition)]) #missing first one... need both names

aucs <- lapply(which(!sapply(outputs,is.null)), function(x) outputs[[x]]@auc)
length(aucs)
names[!sapply(names,is.null)]

hist(unlist(aucs),breaks=5)

```


```{r}
table1 <- lapply(1:60, function(i){
  checkrecords <- pca_herb_SAE[[herbposition[i]]]
  if(is.null(checkrecords)){
    NULL
  } else {
    checkrecords <- checkrecords[checkrecords$Lastobs!="",]
    checkrecords <- checkrecords[!grepl("-99",checkrecords$Lastobs),]
    checkrecords$Lastobs <- as.Date(checkrecords$Lastobs)
    checkrecords <- checkrecords[!is.na(checkrecords$Lastobs),]
      x <- checkrecords
      x <- x[(as.Date(x$Lastobs)>"1980-12-31"),]
      
      data.frame(Species=g1g2names$AcceptedName[i],
        EarlyYrAll = min(as.Date(checkrecords$Lastobs)),
        LateYrAll=max(as.Date(checkrecords$Lastobs)),N=nrow(checkrecords),
                 EarlyYr=min(as.Date(x$Lastobs)),LateYr=max(as.Date(x$Lastobs)),Nsmd=nrow(x))
  }})

write.table(do.call(rbind,table1), "clipboard", sep="\t", row.names = FALSE)
```

```{r}
distXsp[[1]][[1]]

write.table(do.call(rbind,lapply(which(!is.na(herbposition)), function(x){
  data.frame(Species=unique(distXsp[[x]][[1]]$scientificName)[1],
             Area=(sum(distXsp[[x]][[3]]))/1000)
})), "clipboard", sep="\t", row.names=FALSE)

```


```{r}

lapply(1:length(Maxentspecies))
Maxentspecies[[1]][[2]]@auc

# which(!is.na(herbposition))

MEposition2 <- which(MEpos>0)

do.call(rbind,lapply(MEposition2, function(x){
  # if(sum(!is.na(MEposition[x]) & !is.na(herbposition[x]))>0){
    data.frame(Species=unique(Maxentspecies[[x]]$GNAME)[1],
             Area=(sum(distXsp[[backeorposition[x]]][[3]]))/1000,
             AUC=Maxentspecies[[x]][[2]]@auc)
  # } else {
    # data.frame(Species=unique(distXsp[[x]][[1]]$scientificName)[1],
    #            Area=(sum(distXsp[[x]][[3]]))/1000,
    #            AUC=NA)
  # }
  }))



```


